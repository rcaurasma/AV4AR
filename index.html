<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AR + Video + Formulario</title>
  <meta name="description" content="MVP WebAR con botón de video y formulario de Google." />
  <!-- A-Frame (1.0.4) + AR.js (3.3.2) muy compatibles en móviles -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.8); z-index: 9999; color: #fff; }
    .overlay.show { display: flex; }
    .modal { width: min(920px, 95vw); height: min(70vh, 65rem); background: #111; border-radius: 12px; overflow: hidden; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,.5); display: flex; flex-direction: column; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #181818; border-bottom: 1px solid #2a2a2a; }
    .modal-title { font-weight: 600; }
    .modal-actions { display: flex; gap: 8px; }
    button, .btn { appearance: none; border: none; background: #ff5722; color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 14px; cursor: pointer; }
    button.secondary, .btn.secondary { background: #2a2a2a; }
    .modal-body { flex: 1; background: #000; display: grid; }
    .modal-body iframe { width: 100%; height: 100%; border: 0; }
    #fallback { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 14px; padding: 24px; background: linear-gradient(180deg, #141414, #0a0a0a); color: #fff; text-align: center; z-index: 5000; }
    #fallback.show { display: flex; }
    #fallback .card { background: #111; border: 1px solid #2a2a2a; border-radius: 12px; padding: 18px; max-width: 580px; width: 100%; }
    #fallback h1 { font-size: 20px; margin: 0 0 8px; }
    #fallback p { margin: 0 0 16px; color: #c9c9c9; }
    #hint { position: fixed; left: 12px; bottom: 12px; background: rgba(0,0,0,.55); color: #fff; padding: 8px 12px; border-radius: 10px; font-size: 12px; z-index: 3000; border: 1px solid rgba(255,255,255,.1); }
    #topBar { position: fixed; top: 0; left: 0; right: 0; z-index: 4000; display: flex; gap: 8px; padding: 10px; justify-content: center; background: linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,0)); }
    #startAR { background: #1e88e5; }
  </style>
</head>
<body>

  <!-- Barra superior con acciones siempre visibles -->
  <div id="topBar">
    <button id="startAR">Iniciar AR</button>
    <button id="forceFallback" class="secondary">Usar sin AR</button>
  </div>

  <!-- Contenedor donde se inyectará la escena AR tras el clic -->
  <div id="arRoot"></div>

  <div id="hint">Escanea el marcador HIRO. Si no ves la cámara, toca “Usar sin AR”.</div>

  <!-- Fallback sin AR -->
  <div id="fallback" aria-live="polite">
    <div class="card">
      <h1>Experiencia AR</h1>
      <p>No se pudo acceder a la cámara o el dispositivo no soporta WebAR. Puedes continuar sin AR.</p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap: wrap;">
        <button id="fallbackVideo">Ver video</button>
        <button id="fallbackForm" class="secondary">Llenar formulario</button>
      </div>
    </div>
  </div>

  <!-- Overlay de Video -->
  <div id="videoOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="videoTitle">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="videoTitle">Video de presentación</div>
        <div class="modal-actions">
          <button id="btnToForm" class="secondary">Continuar</button>
          <button id="closeVideo" class="secondary">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe id="ytFrame"
                src="about:blank"
                title="Video"
                allow="autoplay; encrypted-media; picture-in-picture"
                allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- Overlay de Formulario (Google Forms) -->
  <div id="formOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="formTitle">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="formTitle">Déjanos tus datos</div>
        <div class="modal-actions">
          <a id="openFormNew" class="btn secondary" target="_blank" rel="noopener">Abrir en nueva pestaña</a>
          <button id="closeForm" class="secondary">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe id="formFrame"
                src="https://docs.google.com/forms/d/e/1FAIpQLSdI3dPM8zakrwwggy4zu7G7lGnqVrAl_qUee6mBGyeuX2IBbw/viewform?embedded=true"
                title="Formulario"
                loading="lazy"></iframe>
      </div>
    </div>
  </div>

  <script>
    // Utilidades overlay
    const videoOverlay = document.getElementById('videoOverlay');
    const formOverlay  = document.getElementById('formOverlay');
    const ytFrame      = document.getElementById('ytFrame');
    const formFrame    = document.getElementById('formFrame');
    const openFormNew  = document.getElementById('openFormNew');
    const fallback     = document.getElementById('fallback');
    const arRoot       = document.getElementById('arRoot');

    function show(el){ el.classList.add('show'); document.body.style.overscrollBehaviorY = 'contain'; }
    function hide(el){ el.classList.remove('show'); document.body.style.overscrollBehaviorY = 'auto'; }

    function showVideo(){
      const base = "https://www.youtube.com/embed/6Ss_SSvLJgw?autoplay=1&rel=0&modestbranding=1&playsinline=1";
      ytFrame.src = base; show(videoOverlay);
    }
    function hideVideo(){ ytFrame.src = "about:blank"; hide(videoOverlay); }
    function showForm(){ openFormNew.href = formFrame.src.replace('&embedded=true','').replace('?embedded=true',''); show(formOverlay); }
    function hideForm(){ hide(formOverlay); }

    document.getElementById('closeVideo').addEventListener('click', hideVideo);
    document.getElementById('btnToForm').addEventListener('click', () => { hideVideo(); showForm(); });
    document.getElementById('closeForm').addEventListener('click', hideForm);

    document.getElementById('fallbackVideo').addEventListener('click', showVideo);
    document.getElementById('fallbackForm').addEventListener('click', showForm);
    document.getElementById('forceFallback').addEventListener('click', () => { show(fallback); });

    // Crea la escena AR SOLO cuando el usuario pulsa "Iniciar AR"
    document.getElementById('startAR').addEventListener('click', () => {
      // Evita duplicados si el usuario pulsa varias veces
      if (document.querySelector('a-scene')) return;

      const scene = document.createElement('a-scene');
      scene.setAttribute('embedded', '');
      scene.setAttribute('vr-mode-ui', 'enabled: false');
      scene.setAttribute('renderer', 'antialias: true; alpha: true; colorManagement: true; powerPreference: high-performance');
      scene.setAttribute('arjs', 'sourceType: webcam; facingMode: environment; debugUIEnabled: false; detectionMode: mono; patternRatio: 0.9;');

      // Marcador HIRO; si tienes tu patrón, reemplaza por type="pattern" url="assets/tu.patt"
      const marker = document.createElement('a-marker');
      marker.setAttribute('preset', 'hiro');

      const box = document.createElement('a-box');
      box.setAttribute('position', '0 0.5 0');
      box.setAttribute('rotation', '0 45 0');
      box.setAttribute('color', '#4CC3D9');
      box.setAttribute('animation', 'property: rotation; to: 0 405 0; loop: true; dur: 3000; easing: linear');

      const btnWrap = document.createElement('a-entity');
      btnWrap.setAttribute('position', '0 0 0.6');
      btnWrap.setAttribute('rotation', '-30 0 0');

      const plane = document.createElement('a-plane');
      plane.setAttribute('id', 'arButton');
      plane.setAttribute('class', 'clickable');
      plane.setAttribute('width', '1.4');
      plane.setAttribute('height', '0.42');
      plane.setAttribute('color', '#FF5722');
      plane.setAttribute('opacity', '0.95');
      plane.setAttribute('material', 'shader: flat');

      const text = document.createElement('a-text');
      text.setAttribute('value', 'Ver video');
      text.setAttribute('align', 'center');
      text.setAttribute('width', '2.5');
      text.setAttribute('color', '#ffffff');
      text.setAttribute('position', '0 0 0.01');

      btnWrap.appendChild(plane);
      btnWrap.appendChild(text);

      const hintText = document.createElement('a-text');
      hintText.setAttribute('value', 'Apunta al marcador HIRO');
      hintText.setAttribute('align', 'center');
      hintText.setAttribute('color', '#fff');
      hintText.setAttribute('position', '0 1.2 0');
      hintText.setAttribute('width', '3');

      marker.appendChild(box);
      marker.appendChild(btnWrap);
      marker.appendChild(hintText);

      const camera = document.createElement('a-entity');
      camera.setAttribute('camera', '');
      const cursor = document.createElement('a-entity');
      cursor.setAttribute('cursor', 'rayOrigin: mouse');
      cursor.setAttribute('raycaster', 'objects: .clickable');
      camera.appendChild(cursor);

      scene.appendChild(marker);
      scene.appendChild(camera);

      arRoot.appendChild(scene);

      // Eventos y salvaguardas
      const fallbackTimer = setTimeout(() => {
        const v = document.querySelector('#arjs-video') || document.querySelector('video[playsinline][autoplay]');
        const ok = v && v.readyState >= 2 && v.videoWidth > 0 && v.videoHeight > 0;
        if (!ok) show(fallback);
      }, 3000);

      scene.addEventListener('camera-error', () => { clearTimeout(fallbackTimer); show(fallback); });
      scene.addEventListener('arjs-video-loaded', () => { clearTimeout(fallbackTimer); hide(fallback); });

      // Click en botón AR
      plane.addEventListener('click', showVideo);
    });

    // Forzar fallback por URL (?fallback=1 o #fallback)
    (function checkForcedFallback(){
      const q = new URLSearchParams(location.search);
      if (q.get('fallback') === '1' || location.hash === '#fallback') show(fallback);
    })();
  </script>
</body>
</html>