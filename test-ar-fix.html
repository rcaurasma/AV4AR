<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AR Test - Fixed Version</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #fff; }
    .container { padding: 20px; text-align: center; }
    button { appearance: none; border: none; background: #1e88e5; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 10px; }
    button.secondary { background: #2a2a2a; }
    #loading { display: none; margin: 20px 0; }
    #loading.show { display: block; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,.3); border-top: 3px solid #1e88e5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #log { background: #111; padding: 16px; margin: 20px 0; border-radius: 8px; font-family: monospace; font-size: 12px; white-space: pre-wrap; text-align: left; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>AR Camera Test - Fixed Version</h1>
    <p>This tests the improved AR camera handling</p>
    
    <div>
      <button id="testCamera">Test Camera Permission</button>
      <button id="simulateAR" class="secondary">Simulate AR Init</button>
    </div>
    
    <div id="loading">
      <div class="loading-spinner"></div>
      <div>Testing camera access...</div>
    </div>
    
    <div id="log"></div>
  </div>

  <script>
    const loadingEl = document.getElementById('loading');
    const logEl = document.getElementById('log');
    
    function log(msg) {
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }
    
    function showLoading() { loadingEl.classList.add('show'); }
    function hideLoading() { loadingEl.classList.remove('show'); }
    
    document.getElementById('testCamera').addEventListener('click', async () => {
      try {
        log('Requesting camera permission...');
        showLoading();
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' }, 
          audio: false 
        });
        
        log('Camera permission granted successfully');
        log(`Stream tracks: ${stream.getTracks().length}`);
        
        // Stop the stream after testing
        stream.getTracks().forEach(track => {
          log(`Stopping track: ${track.kind} - ${track.label}`);
          track.stop();
        });
        
        hideLoading();
        log('Camera test completed successfully');
        
      } catch (error) {
        hideLoading();
        log(`Camera permission denied or error: ${error.name}: ${error.message}`);
        log('This would trigger fallback mode in the AR app');
      }
    });
    
    document.getElementById('simulateAR').addEventListener('click', () => {
      log('Simulating AR initialization process...');
      showLoading();
      
      // Simulate the improved timeout and error handling
      const fallbackTimer = setTimeout(() => {
        // Simulate checking for video element (would fail in test)
        const ok = false; // No actual AR.js video element in test
        log(`Fallback check after 8 seconds: ${ok ? 'SUCCESS' : 'FAILED'}`);
        
        if (!ok) {
          log('AR initialization failed - would show fallback mode');
          hideLoading();
        }
      }, 8000); // Using the new 8-second timeout
      
      log('Fallback timer set for 8 seconds (improved from 3 seconds)');
      
      // Simulate potential success after a few seconds
      setTimeout(() => {
        if (Math.random() > 0.5) {
          clearTimeout(fallbackTimer);
          hideLoading();
          log('Simulated AR success - camera would be active now');
        }
      }, 3000);
    });
    
    // Log initial state
    log('AR Camera Test initialized');
    log(`User agent: ${navigator.userAgent}`);
    log(`MediaDevices available: ${!!navigator.mediaDevices}`);
  </script>
</body>
</html>